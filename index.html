<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>Caja Diaria Europan</title>
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Montserrat', system-ui, sans-serif; background: #f5f0eb; min-height: 100vh; }
    #app { max-width: 480px; margin: 0 auto; }

    .header { background: #4a6741; padding: 18px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .header-title span.semi { font-weight: 600; font-size: 22px; color: #fff; }
    .header-title span.reg { font-weight: 400; font-size: 22px; color: #fff; }
    .btn-back, .btn-hist, .btn-trash-head {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4);
      border-radius: 8px; font-size: 13px; color: #fff; cursor: pointer;
      padding: 7px 12px; font-weight: 600; font-family: inherit;
    }
    .btn-trash-head { font-size: 18px; padding: 7px 10px; }

    .content { padding: 16px; }
    .card { background: #fffdf9; border-radius: 14px; padding: 14px 16px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.07); border: 1px solid #ddd5c8; }
    .section-title { font-size: 12px; font-weight: 700; color: #7a6652; text-transform: uppercase; letter-spacing: 1px; margin: 16px 0 8px; }
    label { font-size: 13px; color: #7a6652; font-weight: 600; display: block; margin-bottom: 6px; }
    input { border: 1px solid #c9bfb2; border-radius: 8px; padding: 10px 12px; font-size: 15px; outline: none; width: 100%; color: #3b3229; background: #faf7f3; font-family: inherit; }
    .row { display: flex; justify-content: space-between; align-items: center; }
    .divider { border-top: 1px solid #e5ddd4; margin-top: 12px; padding-top: 12px; }
    .subtle { font-size: 13px; color: #9e8e7e; }
    .val { font-size: 14px; font-weight: 700; color: #3b3229; }
    .lbl { font-size: 13px; color: #7a6652; font-weight: 600; }

    .albaran-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
    .albaran-row input { flex: 1; }
    .btn-remove { background: none; border: none; color: #c9bfb2; font-size: 18px; cursor: pointer; padding: 6px; flex-shrink: 0; }
    .btn-add { margin-top: 10px; width: 100%; background: #eee8df; border: 1px dashed #c9bfb2; border-radius: 8px; padding: 10px; font-size: 14px; font-weight: 600; cursor: pointer; color: #5c4f42; font-family: inherit; }

    .efectivo-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .efectivo-row .denom { width: 55px; font-size: 14px; font-weight: 600; color: #3b3229; }
    .efectivo-row input { flex: 1; text-align: center; }
    .efectivo-row .total { width: 70px; font-size: 13px; color: #9e8e7e; text-align: right; }
    .subhead { font-size: 12px; color: #9e8e7e; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; margin: 14px 0 10px; }
    .subhead:first-child { margin-top: 0; }

    .result-card { border-radius: 14px; padding: 20px 16px; margin-bottom: 12px; text-align: center; border: 1px solid; }
    .result-icon { font-size: 32px; margin-bottom: 6px; }
    .result-text { font-size: 18px; font-weight: 700; }
    .result-diff { font-size: 14px; margin-top: 4px; }
    .ok { background: #d6e8d0; color: #2d5a27; border-color: #b0cfa8; }
    .err { background: #f5d6d6; color: #7a1e1e; border-color: #e0b0b0; }

    .btn-row { display: flex; gap: 10px; margin-bottom: 24px; }
    .btn-primary { flex: 2; color: #fff; background: #4a6741; border: none; border-radius: 12px; padding: 14px; font-size: 15px; font-weight: 700; cursor: pointer; font-family: inherit; }
    .btn-primary.saved { background: #5a8f50; }
    .btn-primary:disabled { opacity: 0.7; }
    .btn-secondary { flex: 1; background: #e8e0d5; color: #5c4f42; border: none; border-radius: 12px; padding: 14px; font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit; }

    .error-msg { background: #f5d6d6; color: #7a1e1e; font-weight: 600; padding: 12px 16px; border-radius: 10px; margin-bottom: 12px; font-size: 14px; }

    .hist-item { cursor: pointer; }
    .hist-fecha { font-weight: 700; font-size: 15px; color: #3b3229; }
    .hist-sub { font-size: 13px; color: #9e8e7e; margin-top: 2px; }
    .hist-nota { font-size: 12px; color: #9e8e7e; margin-top: 2px; font-style: italic; }
    .pill { font-size: 12px; font-weight: 700; padding: 4px 10px; border-radius: 20px; white-space: nowrap; }
    .pill-ok { background: #c8dfc2; color: #2d5a27; }
    .pill-err { background: #f0d0d0; color: #7a1e1e; }
    .btn-trash { background: none; border: none; font-size: 16px; cursor: pointer; color: #c9bfb2; padding: 4px; }

    .confirm-card { background: #f5d6d6; text-align: center; border-color: #e0b0b0; }
    .confirm-card p { font-weight: 700; color: #7a1e1e; margin-bottom: 12px; }
    .confirm-card .btn-row { margin-bottom: 0; }

    .btn-load { margin-bottom: 12px; width: 100%; background: #eee8df; border: 1px solid #c9bfb2; border-radius: 8px; padding: 10px; font-size: 14px; font-weight: 600; cursor: pointer; color: #5c4f42; font-family: inherit; }
    .empty { text-align: center; color: #9e8e7e; margin-top: 40px; font-style: italic; }

    .detalle-badge { text-align: center; padding: 10px; border-radius: 10px; font-weight: 700; font-size: 15px; margin: 12px 0 0; }

    .view { display: none; }
    .view.active { display: block; }
  </style>
</head>
<body>
<div id="app"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbwmYtiE-KZtkESLmUAy1FMoijv9SOacUIgfIGw1xWXGYgLTPCWn2hgS-TcB8kBvoPk6/exec";
const BILLETES = [500, 200, 100, 50, 20, 10, 5];
const MONEDAS = [2, 1, 0.5, 0.2, 0.1, 0.05, 0.02, 0.01];

const fmt = n => parseFloat(n).toFixed(2).replace(".", ",") + " ‚Ç¨";

function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cb = "cb" + Date.now() + Math.floor(Math.random() * 10000);
    const script = document.createElement("script");
    const timer = setTimeout(() => { delete window[cb]; script.remove(); reject(new Error("Timeout")); }, 15000);
    window[cb] = data => { clearTimeout(timer); delete window[cb]; script.remove(); resolve(data); };
    script.onerror = () => { clearTimeout(timer); delete window[cb]; script.remove(); reject(new Error("Error de conexi√≥n")); };
    script.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
    document.head.appendChild(script);
  });
}

const apiCall = body => jsonp(API + "?data=" + encodeURIComponent(JSON.stringify(body)));
const apiGet = () => jsonp(API + "?dummy=1");

// Estado
let state = {
  view: "caja",
  fecha: new Date().toISOString().slice(0, 10),
  notas: "",
  albaranes: [{ id: 1, num: "", importe: "" }],
  efectivo: {},
  bolsa: "",
  historial: [],
  detalleIdx: null,
  saving: false,
  saved: false,
  loading: false,
  confirmClear: false,
  error: ""
};
BILLETES.concat(MONEDAS).forEach(v => state.efectivo[v] = "");

function totalAlbaranes() {
  return state.albaranes.reduce((s, a) => s + (parseFloat(a.importe.replace(",", ".")) || 0), 0);
}
function totalEfectivo() {
  return BILLETES.concat(MONEDAS).reduce((s, v) => s + v * (parseInt(state.efectivo[v]) || 0), 0)
    + (parseFloat(state.bolsa) || 0);
}
function diferencia() { return totalEfectivo() - totalAlbaranes(); }
function cuadra() { return Math.abs(diferencia()) < 0.005; }

function setState(updates) { Object.assign(state, updates); render(); }

function resetForm() {
  const ef = {};
  BILLETES.concat(MONEDAS).forEach(v => ef[v] = "");
  setState({ albaranes: [{id:1,num:"",importe:""}], efectivo: ef, bolsa: "", fecha: new Date().toISOString().slice(0,10), notas: "", error: "", saved: false });
}

async function guardar() {
  setState({ saving: true, error: "" });
  const registro = {
    action: "save",
    ts: Date.now(), fecha: state.fecha, notas: state.notas, bolsa: state.bolsa,
    albaranes: state.albaranes.filter(a => a.importe),
    efectivo: {...state.efectivo},
    totalAlbaranes: totalAlbaranes(), totalEfectivo: totalEfectivo(),
    diferencia: diferencia(), cuadra: cuadra()
  };
  try {
    await apiCall(registro);
    setState({ saving: false, saved: true, error: "" });
    setTimeout(() => setState({ saved: false }), 2000);
  } catch(e) {
    setState({ saving: false, error: "Error al guardar: " + e.message });
  }
}

async function cargarHistorial() {
  setState({ loading: true, error: "" });
  try {
    const data = await apiGet();
    const registros = (data.rows || [])
      .filter(r => r[0] && r[1])
      .map(r => ({
        ts: r[0], fecha: r[1], notas: r[2],
        totalAlbaranes: parseFloat(r[3]) || 0,
        totalEfectivo: parseFloat(r[4]) || 0,
        diferencia: parseFloat(r[5]) || 0,
        cuadra: r[6] === true || r[6] === "true" || r[6] === "TRUE",
        albaranes: typeof r[7] === "string" ? JSON.parse(r[7]) : [],
        efectivo: typeof r[8] === "string" ? JSON.parse(r[8]) : {},
        bolsa: r[9] || ""
      })).reverse();
    setState({ loading: false, historial: registros });
  } catch(e) {
    setState({ loading: false, error: "Error al cargar: " + e.message });
  }
}

async function eliminarRegistro(ts) {
  try {
    await apiCall({ action: "delete", ts });
    setState({ historial: state.historial.filter(r => String(r.ts) !== String(ts)) });
  } catch(e) {
    setState({ error: "Error al eliminar: " + e.message });
  }
}

async function limpiarHistorial() {
  try {
    await apiCall({ action: "deleteAll" });
    setState({ historial: [], confirmClear: false });
  } catch(e) {
    setState({ error: "Error al limpiar: " + e.message });
  }
}

function header(leftHtml, rightHtml) {
  return `<div class="header">
    ${leftHtml || '<div style="width:80px"></div>'}
    <div class="header-title"><span class="semi">Caja Diaria </span><span class="reg">Europan</span></div>
    ${rightHtml || '<div style="width:80px"></div>'}
  </div>`;
}

function renderCaja() {
  const ta = totalAlbaranes(), te = totalEfectivo(), df = diferencia(), ok = cuadra();
  const resClass = ok || df > 0 ? "ok" : "err";
  const resText = ok ? "Caja cuadrada" : df > 0 ? "Sobra dinero" : "Falta dinero";
  const resIcon = ok || df > 0 ? "‚úÖ" : "‚ùå";

  let albaranesHtml = state.albaranes.map((a, i) => `
    <div class="albaran-row">
      <input placeholder="Concepto" value="${a.num}" oninput="state.albaranes[${i}].num=this.value" />
      <input placeholder="Importe ‚Ç¨" value="${a.importe}" inputmode="decimal" oninput="state.albaranes[${i}].importe=this.value;render()" />
      <button class="btn-remove" onclick="removeAlbaran(${a.id})">‚úï</button>
    </div>`).join("");

  let billetesHtml = BILLETES.map(v => `
    <div class="efectivo-row">
      <span class="denom">${v} ‚Ç¨</span>
      <input type="number" min="0" inputmode="numeric" placeholder="0" value="${state.efectivo[v]}" oninput="state.efectivo[${v}]=this.value;render()" />
      <span class="total">${fmt(v * (parseInt(state.efectivo[v]) || 0))}</span>
    </div>`).join("");

  let monedasHtml = MONEDAS.map(v => `
    <div class="efectivo-row">
      <span class="denom">${v} ‚Ç¨</span>
      <input type="number" min="0" inputmode="numeric" placeholder="0" value="${state.efectivo[v]}" oninput="state.efectivo[${v}]=this.value;render()" />
      <span class="total">${fmt(v * (parseInt(state.efectivo[v]) || 0))}</span>
    </div>`).join("");

  return `
    ${header('', '<button class="btn-hist" onclick="setState({view:\'historial\'})">Historial</button>')}
    <div class="content">
      ${state.error ? `<div class="error-msg">${state.error}</div>` : ""}
      <div class="card">
        <div style="display:flex;gap:10px;align-items:flex-end">
          <div style="flex:1"><label>Fecha</label><input type="date" value="${state.fecha}" oninput="state.fecha=this.value" /></div>
          <div style="flex:2"><label>Notas</label><input type="text" placeholder="Observaciones..." value="${state.notas}" oninput="state.notas=this.value" /></div>
        </div>
      </div>
      <div class="section-title">Albaranes</div>
      <div class="card">
        ${albaranesHtml}
        <button class="btn-add" onclick="addAlbaran()">+ A√±adir albar√°n</button>
        <div class="row divider"><span class="lbl">Total albaranes</span><span class="val">${fmt(ta)}</span></div>
      </div>
      <div class="section-title">Efectivo en caja</div>
      <div class="card">
        <div class="subhead">Billetes</div>
        ${billetesHtml}
        <div class="subhead">Monedas</div>
        ${monedasHtml}
        <div class="subhead">Bolsa sin contar</div>
        <div class="efectivo-row">
          <span class="denom">Importe</span>
          <input type="number" min="0" inputmode="decimal" placeholder="0,00" value="${state.bolsa}" oninput="state.bolsa=this.value;render()" />
          <span class="total">${fmt(parseFloat(state.bolsa) || 0)}</span>
        </div>
        <div class="row divider"><span class="lbl">Total efectivo</span><span class="val">${fmt(te)}</span></div>
      </div>
      <div class="result-card ${resClass}">
        <div class="result-icon">${resIcon}</div>
        <div class="result-text">${resText}</div>
        ${!ok ? `<div class="result-diff">Diferencia: ${df > 0 ? "+" : ""}${fmt(df)}</div>` : ""}
      </div>
      <div class="btn-row">
        <button class="btn-secondary" onclick="resetForm()">Limpiar</button>
        <button class="btn-primary${state.saved ? " saved" : ""}" onclick="guardar()" ${state.saving ? "disabled" : ""}>
          ${state.saving ? "Guardando..." : state.saved ? "‚úì Guardado" : "Guardar registro"}
        </button>
      </div>
    </div>`;
}

function renderHistorial() {
  const items = state.historial.map((r, i) => {
    const ok = r.cuadra || r.diferencia > 0;
    const pillText = r.cuadra ? "Cuadra" : r.diferencia > 0 ? ("+" + fmt(r.diferencia)) : fmt(r.diferencia);
    return `<div class="card">
      <div class="row">
        <div class="hist-item" style="flex:1" onclick="setState({detalleIdx:${i},view:'detalle'})">
          <div class="hist-fecha">${r.fecha}</div>
          <div class="hist-sub">${r.albaranes.length} albar√°n${r.albaranes.length!==1?"es":""} ¬∑ ${fmt(r.totalAlbaranes)}</div>
          ${r.notas ? `<div class="hist-nota">"${r.notas}"</div>` : ""}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="pill ${ok?"pill-ok":"pill-err"}">${pillText}</span>
          <button class="btn-trash" onclick="eliminarRegistro('${r.ts}')">üóë</button>
        </div>
      </div>
    </div>`;
  }).join("");

  return `
    ${header(
      '<button class="btn-back" onclick="setState({view:\'caja\'})">‚Üê Volver</button>',
      '<button class="btn-trash-head" onclick="setState({confirmClear:true})">üóë</button>'
    )}
    <div class="content">
      <div class="section-title">Historial de cierres</div>
      ${state.error ? `<div class="error-msg">${state.error}</div>` : ""}
      ${state.confirmClear ? `<div class="card confirm-card">
        <p>¬øBorrar todo el historial?</p>
        <div class="btn-row">
          <button class="btn-secondary" onclick="setState({confirmClear:false})">Cancelar</button>
          <button class="btn-primary" style="background:#c0392b" onclick="limpiarHistorial()">Borrar todo</button>
        </div>
      </div>` : ""}
      <button class="btn-load" onclick="cargarHistorial()">${state.loading ? "Cargando..." : "üîÑ Cargar historial"}</button>
      ${state.historial.length === 0 && !state.loading ? '<div class="empty">Pulsa "Cargar historial" para ver los registros</div>' : items}
    </div>`;
}

function renderDetalle() {
  const r = state.historial[state.detalleIdx];
  if (!r) return renderHistorial();
  const ok = r.cuadra || r.diferencia > 0;
  const resClass = ok ? "ok" : "err";
  const resMsg = r.cuadra ? "Caja cuadrada" : r.diferencia > 0 ? ("Sobra: +" + fmt(r.diferencia)) : ("Falta: " + fmt(r.diferencia));

  const efectivoItems = BILLETES.concat(MONEDAS).map(v => {
    const cant = parseInt(r.efectivo[v]) || 0;
    if (!cant) return "";
    return `<div class="row" style="margin-bottom:6px">
      <span class="lbl">${v >= 5 ? "Billete" : "Moneda"} ${v} ‚Ç¨ √ó ${cant}</span>
      <span class="val">${fmt(v * cant)}</span>
    </div>`;
  }).join("");

  return `
    ${header('<button class="btn-back" onclick="setState({view:\'historial\'})">‚Üê Volver</button>')}
    <div class="content">
      <div class="card">
        <div class="row"><span class="lbl">Fecha</span><span class="val">${r.fecha}</span></div>
        ${r.notas ? `<div class="row" style="margin-top:8px"><span class="lbl">Notas</span><span class="val">${r.notas}</span></div>` : ""}
        <div class="detalle-badge ${resClass}">${resMsg}</div>
      </div>
      <div class="card">
        <div class="row"><span class="lbl">Total albaranes</span><span class="val">${fmt(r.totalAlbaranes)}</span></div>
        <div class="row" style="margin-top:8px"><span class="lbl">Total efectivo</span><span class="val">${fmt(r.totalEfectivo)}</span></div>
      </div>
      <div class="section-title">Albaranes</div>
      <div class="card">
        ${r.albaranes.map((a, i) => `<div class="row" style="margin-bottom:6px">
          <span class="lbl">${a.num || "Albar√°n " + (i+1)}</span>
          <span class="val">${fmt(parseFloat(a.importe.replace(",",".")) || 0)}</span>
        </div>`).join("")}
      </div>
      <div class="section-title">Efectivo</div>
      <div class="card">
        ${efectivoItems}
        ${r.bolsa && parseFloat(r.bolsa) > 0 ? `<div class="row divider"><span class="lbl">Bolsa sin contar</span><span class="val">${fmt(r.bolsa)}</span></div>` : ""}
      </div>
    </div>`;
}

function addAlbaran() {
  state.albaranes.push({ id: Date.now(), num: "", importe: "" });
  render();
}
function removeAlbaran(id) {
  if (state.albaranes.length > 1) state.albaranes = state.albaranes.filter(a => a.id !== id);
  render();
}

function render() {
  const app = document.getElementById("app");
  if (state.view === "caja") app.innerHTML = renderCaja();
  else if (state.view === "historial") app.innerHTML = renderHistorial();
  else if (state.view === "detalle") app.innerHTML = renderDetalle();
}

render();
</script>
</body>
</html>
